<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoração Network - Estúdios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --raspberry-red: #c51d4a;
            --raspberry-dark: #8b1e41;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --danger-red: #dc3545;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--raspberry-red) !important;
        }
        
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .status-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .online {
            background-color: var(--success-green);
            box-shadow: 0 0 10px var(--success-green);
        }
        
        .offline {
            background-color: var(--danger-red);
            box-shadow: 0 0 10px var(--danger-red);
        }
        
        .loading {
            background-color: var(--warning-yellow);
            box-shadow: 0 0 10px var(--warning-yellow);
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        .btn-primary {
            background-color: var(--raspberry-red);
            border-color: var(--raspberry-red);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--raspberry-dark);
            border-color: var(--raspberry-dark);
        }
        
        .action-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .test-results {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .test-results pre {
            margin: 0;
            white-space: pre-wrap;
        }
        
        #speedtestResults .progress {
            height: 25px;
            margin-bottom: 15px;
            background-color: #e9ecef;
        }
        
        #speedtestResults .progress-bar {
            background-color: var(--raspberry-red);
            font-weight: 600;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .raspberry-logo {
            width: 30px;
            height: 30px;
            margin-right: 8px;
        }
        
        .pill-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-online {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-green);
        }
        
        .status-offline {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-red);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-raspberry"></i> Monitoração Network - Estúdios
            </a>
            <div>
                <button class="btn btn-sm btn-outline-secondary" id="refreshAllBtn">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar Tudo
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Status Geral -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-activity"></i> Status Geral
                </span>
                <button class="btn btn-sm btn-outline-secondary" id="refreshStatusBtn">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
            <div class="card-body">
                <div class="row" id="statusContainer">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <!-- Dispositivos -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-hdd-network"></i> Dispositivos
                    </div>
                    <div class="card-body">
                        {% for raspberry in raspberries %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">{{ raspberry.nome }}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">{{ raspberry.ip }} - {{ raspberry.descricao }}</h6>
                                
                                <div class="action-buttons mt-3">
                                    <button class="btn btn-sm btn-primary ping-btn" data-id="{{ raspberry.id }}">
                                        <i class="bi bi-broadcast"></i> Ping
                                    </button>
                                    <button class="btn btn-sm btn-primary curl-btn" data-id="{{ raspberry.id }}">
                                        <i class="bi bi-code-slash"></i> Curl
                                    </button>
                                    <button class="btn btn-sm btn-primary speedtest-btn" data-id="{{ raspberry.id }}">
                                        <i class="bi bi-speedometer2"></i> Speedtest
                                    </button>
                                </div>
                                
                                <div class="test-results mt-3 d-none" id="results-{{ raspberry.id }}">
                                    <pre>Resultados aparecem aqui...</pre>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Speedtest servidor local -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Servidor Local</h5>
                                <h6 class="card-subtitle mb-2 text-muted">Este servidor - Dashboard</h6>
                                
                                <div class="action-buttons mt-3">
                                    <button class="btn btn-sm btn-primary" id="localSpeedtestBtn">
                                        <i class="bi bi-speedometer2"></i> Speedtest Local
                                    </button>
                                </div>
                                
                                <div class="test-results mt-3 d-none" id="local-speedtest-results">
                                    <pre>Resultados aparecem aqui...</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <!-- Resultados do Speedtest -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-speedometer2"></i> Resultado do Último Speedtest
                    </div>
                    <div class="card-body" id="speedtestResults">
                        <div class="text-center text-muted">
                            <p>Execute um teste de velocidade para ver os resultados.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-graph-up"></i> Gráficos de Desempenho
                        </span>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active" data-chart="latency">Latência</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-chart="speed">Velocidade</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                            <div class="loading-overlay" id="chartLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Status inicial
            updateStatus();
            
            // Configurar o gráfico
            setupChart();
            
            // Event listeners
            document.getElementById('refreshStatusBtn').addEventListener('click', updateStatus);
            document.getElementById('refreshAllBtn').addEventListener('click', refreshAll);
            document.getElementById('localSpeedtestBtn').addEventListener('click', runLocalSpeedtest);
            
            // Botões de ping
            document.querySelectorAll('.ping-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const raspberryId = this.getAttribute('data-id');
                    runPing(raspberryId);
                });
            });
            
            // Botões de curl
            document.querySelectorAll('.curl-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const raspberryId = this.getAttribute('data-id');
                    runCurl(raspberryId);
                });
            });
            
            // Botões de speedtest
            document.querySelectorAll('.speedtest-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const raspberryId = this.getAttribute('data-id');
                    runSpeedtest(raspberryId);
                });
            });
            
            // Troca de gráficos
            document.querySelectorAll('[data-chart]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[data-chart]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateChart(this.getAttribute('data-chart'));
                });
            });
        });
        
        // Variáveis globais
        let performanceChart;
        let currentChartType = 'latency';
        let chartData = {
            latency: {
                labels: [],
                datasets: []
            },
            speed: {
                labels: [],
                datasets: []
            }
        };
        
        // Atualizar status de todos os dispositivos
        function updateStatus() {
            const statusContainer = document.getElementById('statusContainer');
            statusContainer.innerHTML = `
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            `;
            
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    
                    data.forEach(device => {
                        const statusClass = device.online ? 'status-online' : 'status-offline';
                        const statusText = device.online ? 'Online' : 'Offline';
                        const portaStatus = device.porta_aberta ? 'Acessível' : 'Inacessível';
                        const portaClass = device.porta_aberta ? 'status-online' : 'status-offline';
                        const latenciaText = device.latencia ? `${device.latencia} ms` : 'N/A';
                        
                        html += `
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">${device.nome}</h5>
                                        <p class="card-text text-muted">${device.ip}</p>
                                        <p class="card-text">${device.descricao}</p>
                                        
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Status:</span>
                                            <span class="pill-status ${statusClass}">${statusText}</span>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Serviço Web:</span>
                                            <span class="pill-status ${portaClass}">${portaStatus}</span>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Latência:</span>
                                            <span>${latenciaText}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    statusContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao atualizar status:', error);
                    statusContainer.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Erro ao carregar status: ${error.message}
                            </div>
                        </div>
                    `;
                });
        }
        
        // Executar ping
        function runPing(raspberryId) {
            const resultsElement = document.getElementById(`results-${raspberryId}`);
            resultsElement.classList.remove('d-none');
            resultsElement.querySelector('pre').textContent = 'Executando ping...';
            
            fetch(`/api/ping/${raspberryId}`)
                .then(response => response.json())
                .then(data => {
                    let resultText = '';
                    
                    if (data.online) {
                        resultText = `✅ Ping bem sucedido!\n`;
                        resultText += `Latência: ${data.latencia ? data.latencia + ' ms' : 'N/A'}\n`;
                        resultText += `Tempo total: ${data.duracao.toFixed(2)} segundos\n\n`;
                        resultText += `Saída completa:\n${data.raw_output}`;
                    } else {
                        resultText = `❌ Ping falhou!\n`;
                        resultText += `Tempo total: ${data.duracao.toFixed(2)} segundos\n\n`;
                        resultText += `Saída:\n${data.raw_output}`;
                    }
                    
                    resultsElement.querySelector('pre').textContent = resultText;
                    
                    // Atualizar status após o ping
                    updateStatus();
                })
                .catch(error => {
                    resultsElement.querySelector('pre').textContent = `Erro ao executar ping: ${error.message}`;
                });
        }
        
        // Executar curl
        function runCurl(raspberryId) {
            const resultsElement = document.getElementById(`results-${raspberryId}`);
            resultsElement.classList.remove('d-none');
            resultsElement.querySelector('pre').textContent = 'Executando curl...';
            
            fetch(`/api/curl/${raspberryId}`)
                .then(response => response.json())
                .then(data => {
                    let resultText = '';
                    
                    if (data.sucesso) {
                        resultText = `✅ Curl bem sucedido!\n`;
                        resultText += `Status HTTP: ${data.status_code}\n`;
                        resultText += `Tempo de resposta: ${data.tempo_resposta.toFixed(2)} segundos\n`;
                        resultText += `Tamanho da resposta: ${(data.tamanho_resposta / 1024).toFixed(2)} KB\n\n`;
                        resultText += `Headers:\n`;
                        
                        for (const [key, value] of Object.entries(data.headers)) {
                            resultText += `${key}: ${value}\n`;
                        }
                    } else {
                        resultText = `❌ Curl falhou!\n`;
                        resultText += `Erro: ${data.erro}`;
                    }
                    
                    resultsElement.querySelector('pre').textContent = resultText;
                })
                .catch(error => {
                    resultsElement.querySelector('pre').textContent = `Erro ao executar curl: ${error.message}`;
                });
        }
        
        // Executar speedtest local
        function runLocalSpeedtest() {
            const resultsElement = document.getElementById('local-speedtest-results');
            resultsElement.classList.remove('d-none');
            resultsElement.querySelector('pre').textContent = 'Executando speedtest...\nIsso pode demorar um pouco (até 30 segundos).';
            
            fetch('/api/speedtest/local')
                .then(response => response.json())
                .then(data => {
                    let resultText = '';
                    
                    if (data.sucesso) {
                        const result = data.resultado;
                        resultText = `✅ Speedtest bem sucedido!\n\n`;
                        resultText += `Download: ${(result.download / 1000000).toFixed(2)} Mbps\n`;
                        resultText += `Upload: ${(result.upload / 1000000).toFixed(2)} Mbps\n`;
                        resultText += `Ping: ${result.ping.toFixed(2)} ms\n`;
                        resultText += `ISP: ${result.client.isp}\n`;
                        resultText += `Servidor: ${result.server.sponsor} (${result.server.name}, ${result.server.country})\n`;
                        
                        // Atualizar o painel de resultados
                        updateSpeedtestResults(result);
                        
                        // Atualizar o gráfico de desempenho
                        updateHistoricalData();
                    } else {
                        resultText = `❌ Speedtest falhou!\n`;
                        resultText += `Erro: ${data.erro}`;
                    }
                    
                    resultsElement.querySelector('pre').textContent = resultText;
                })
                .catch(error => {
                    resultsElement.querySelector('pre').textContent = `Erro ao executar speedtest: ${error.message}`;
                });
        }
        
        // Executar speedtest em um Raspberry Pi remoto
        function runSpeedtest(raspberryId) {
            const resultsElement = document.getElementById(`results-${raspberryId}`);
            resultsElement.classList.remove('d-none');
            resultsElement.querySelector('pre').textContent = 'Executando speedtest...\nIsso pode demorar um pouco (até 30 segundos).';
            
            fetch(`/api/speedtest/${raspberryId}`)
                .then(response => response.json())
                .then(data => {
                    let resultText = '';
                    
                    if (data.sucesso) {
                        resultText = `✅ Speedtest bem sucedido!\n\n`;
                        resultText += data.resultado;
                        
                        // Tentar extrair valores numéricos para o gráfico
                        try {
                            const downloadMatch = data.resultado.match(/Download:\s+(\d+\.\d+) Mbps \(data used: (\d+\.\d+) MB\)/);
                            const uploadMatch = data.resultado.match(/Upload:\s+(\d+\.\d+) Mbps \(data used: (\d+\.\d+) MB\)/);
                            const pingMatch = data.resultado.match(/Idle Latency:\s+(\d+\.\d+) ms\s+\(jitter: (\d+\.\d+)ms, low: (\d+\.\d+)ms, high: (\d+\.\d+)ms\)/);
                            
                            if (downloadMatch && uploadMatch && pingMatch) {
                                const speedResult = {
                                    download: parseFloat(downloadMatch[1]),
                                    upload: parseFloat(uploadMatch[1]),
                                    ping: parseFloat(pingMatch[1]),
                                    timestamp: new Date().toISOString()
                                };
                                
                                // Atualizar o gráfico de desempenho
                                updateHistoricalData();
                            }
                        } catch (e) {
                            console.error('Erro ao processar resultado remoto:', e);
                        }
                    } else {
                        resultText = `❌ Speedtest falhou!\n`;
                        resultText += `Erro: ${data.erro}`;
                    }
                    
                    resultsElement.querySelector('pre').textContent = resultText;
                })
                .catch(error => {
                    resultsElement.querySelector('pre').textContent = `Erro ao executar speedtest: ${error.message}`;
                });
        }
        
        // Atualizar painel de resultados do speedtest
        function updateSpeedtestResults(result) {
            const container = document.getElementById('speedtestResults');
            
            const download = (result.download / 1000000).toFixed(2);
            const upload = (result.upload / 1000000).toFixed(2);
            const ping = result.ping.toFixed(2);
            
            // Calcular porcentagens para barras de progresso (baseado em 100 Mbps)
            const downloadPercent = Math.min(download / 100 * 100, 100);
            const uploadPercent = Math.min(upload / 100 * 100, 100);
            
            let html = `
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <strong>Download</strong>
                        <span>${download} Mbps</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${downloadPercent}%" 
                             aria-valuenow="${download}" aria-valuemin="0" aria-valuemax="100">
                             ${download} Mbps
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <strong>Upload</strong>
                        <span>${upload} Mbps</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${uploadPercent}%" 
                             aria-valuenow="${upload}" aria-valuemin="0" aria-valuemax="100">
                             ${upload} Mbps
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h3 class="display-4 mb-2">${ping}</h3>
                                <p class="text-muted">Ping (ms)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="mb-2">${result.client.isp}</h5>
                                <p class="text-muted">Provedor</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="mb-2">${result.server.sponsor}</h5>
                                <p class="text-muted">Servidor</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-muted small mt-2">
                    Teste realizado em: ${new Date().toLocaleString()}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Configurar o gráfico de desempenho
        function setupChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: chartData.latency,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Latência (ms)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data/Hora'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const timestamp = context[0].label;
                                    const date = new Date(timestamp);
                                    return date.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Carregar dados históricos
            updateHistoricalData();
        }
        
        // Atualizar o tipo de gráfico
        function updateChart(chartType) {
            currentChartType = chartType;
            
            // Atualizar configurações do eixo Y
            if (chartType === 'latency') {
                performanceChart.options.scales.y.title.text = 'Latência (ms)';
            } else if (chartType === 'speed') {
                performanceChart.options.scales.y.title.text = 'Velocidade (Mbps)';
            }
            
            // Atualizar dados
            performanceChart.data = chartData[chartType];
            performanceChart.update();
        }
        
        // Carregar dados históricos para os gráficos
        function updateHistoricalData() {
            document.getElementById('chartLoading').style.display = 'flex';
            
            // Carregar dados de ping para o gráfico de latência
            fetch('/api/historico/ping')
                .then(response => response.json())
                .then(data => {
                    // Processar dados de latência
                    const datasets = {};
                    
                    // Agrupar por Raspberry Pi
                    data.forEach(entry => {
                        if (entry.online && entry.latencia) {
                            const raspberryId = entry.raspberry_id;
                            
                            if (!datasets[raspberryId]) {
                                datasets[raspberryId] = {
                                    label: `Raspberry ${raspberryId}`,
                                    data: [],
                                    borderColor: getColor(raspberryId),
                                    backgroundColor: getColor(raspberryId, 0.1),
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    tension: 0.2
                                };
                            }
                            
                            datasets[raspberryId].data.push({
                                x: entry.timestamp,
                                y: entry.latencia
                            });
                        }
                    });
                    
                    // Ordenar timestamps
                    Object.values(datasets).forEach(dataset => {
                        dataset.data.sort((a, b) => new Date(a.x) - new Date(b.x));
                    });
                    
                    // Atualizar dados do gráfico
                    chartData.latency.datasets = Object.values(datasets);
                    
                    // Carregar dados de speedtest para o gráfico de velocidade
                    return fetch('/api/historico/speedtest');
                })
                .then(response => response.json())
                .then(data => {
                    // Processar dados de velocidade
                    const downloadDatasets = {};
                    const uploadDatasets = {};
                    
                    // Agrupar por Raspberry Pi
                    data.forEach(entry => {
                        if (entry.sucesso && entry.resultado) {
                            const raspberryId = entry.raspberry_id;
                            let download, upload;
                            
                            // Tentar extrair valores
                            try {
                                if (typeof entry.resultado === 'string') {
                                    // Formato string (para Raspberry Pis remotos)
                                    const downloadMatch = entry.resultado.match(/Download:\s+(\d+\.\d+) Mbps \(data used: (\d+\.\d+) MB\)/);
                                    const uploadMatch = entry.resultado.match(/Upload:\s+(\d+\.\d+) Mbps \(data used: (\d+\.\d+) MB\)/);
                                    
                                    if (downloadMatch && uploadMatch) {
                                        download = parseFloat(downloadMatch[1]);
                                        upload = parseFloat(uploadMatch[1]);
                                    }
                                } else {
                                    // Formato JSON (para servidor local)
                                    download = (entry.resultado.download / 1000000).toFixed(2);
                                    upload = (entry.resultado.upload / 1000000).toFixed(2);
                                }
                                
                                // Adicionar aos datasets se os valores foram extraídos
                                if (download !== undefined) {
                                    if (!downloadDatasets[raspberryId]) {
                                        downloadDatasets[raspberryId] = {
                                            label: `Download Raspberry ${raspberryId}`,
                                            data: [],
                                            borderColor: getColor(raspberryId),
                                            backgroundColor: getColor(raspberryId, 0.1),
                                            borderWidth: 2,
                                            pointRadius: 3,
                                            tension: 0.2
                                        };
                                    }
                                    
                                    downloadDatasets[raspberryId].data.push({
                                        x: entry.timestamp,
                                        y: download
                                    });
                                }
                                
                                if (upload !== undefined) {
                                    if (!uploadDatasets[raspberryId]) {
                                        uploadDatasets[raspberryId] = {
                                            label: `Upload Raspberry ${raspberryId}`,
                                            data: [],
                                            borderColor: getColor(raspberryId, 1, true),
                                            backgroundColor: getColor(raspberryId, 0.1, true),
                                            borderWidth: 2,
                                            pointRadius: 3,
                                            borderDash: [5, 5],
                                            tension: 0.2
                                        };
                                    }
                                    
                                    uploadDatasets[raspberryId].data.push({
                                        x: entry.timestamp,
                                        y: upload
                                    });
                                }
                            } catch (e) {
                                console.error('Erro ao processar dados de velocidade:', e);
                            }
                        }
                    });
                    
                    // Ordenar timestamps
                    Object.values(downloadDatasets).forEach(dataset => {
                        dataset.data.sort((a, b) => new Date(a.x) - new Date(b.x));
                    });
                    
                    Object.values(uploadDatasets).forEach(dataset => {
                        dataset.data.sort((a, b) => new Date(a.x) - new Date(b.x));
                    });
                    
                    // Atualizar dados do gráfico
                    chartData.speed.datasets = [
                        ...Object.values(downloadDatasets),
                        ...Object.values(uploadDatasets)
                    ];
                    
                    // Atualizar o gráfico atual
                    performanceChart.data = chartData[currentChartType];
                    performanceChart.update();
                    
                    document.getElementById('chartLoading').style.display = 'none';
                })
                .catch(error => {
                    console.error('Erro ao carregar dados históricos:', error);
                    document.getElementById('chartLoading').style.display = 'none';
                });
        }
        
        // Obter cor baseada no ID do Raspberry Pi
        function getColor(id, alpha = 1, isUpload = false) {
            const colors = [
                'rgb(220, 53, 69)', // Vermelho
                'rgb(40, 167, 69)', // Verde
                'rgb(0, 123, 255)', // Azul
                'rgb(255, 193, 7)'  // Amarelo
            ];
            
            const baseColor = colors[id % colors.length];
            
            if (isUpload) {
                // Cor mais clara para upload
                const rgb = baseColor.match(/\d+/g);
                return `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${alpha})`;
            } else {
                // Cor normal para download/latência
                const rgb = baseColor.match(/\d+/g);
                return `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${alpha})`;
            }
        }
        
        // Atualizar tudo
        function refreshAll() {
            updateStatus();
            updateHistoricalData();
        }
    </script>
</body>
</html>
